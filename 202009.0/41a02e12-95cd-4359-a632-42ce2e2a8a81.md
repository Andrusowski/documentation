> Audience:
>
> - Developers who debug using the Docker SDK.
>
> Outcome:
> - You know how to configure debugging.
> - You know how to debug web applications, API, and console commands.


This document describes how to configure debugging of Spryker in Docker.

[Xdebug](https://xdebug.org) is the default debugging tool for Spryker in Docker. To enable Xdebug, run the command:
```bash
docker/sdk {run|start|up} -x
```

## Configuring Xdebug in PhpStorm

This section describes the required configuration for Xdebug in PhpStorm.

### Prerequisites

1. PHPStorm - Early Access Program(EAP) preferred
 - You can download PHPStorm through the [Jetbrains Toolbox](https://www.jetbrains.com/toolbox-app/)
2. Xdebug 
 - You can install and verify it [here](https://xdebug.org/docs/install)
3. [Xdebug extension](https://www.jetbrains.com/help/phpstorm/2021.1/browser-debugging-extensions.html)
 - set the debug key to `PHPSTORM`

### Configuring Xdebug

To configure Xdebug in PhpStorm:

1. Open your preferences, either from the main dropdown or with `Cmd/Ctrl + ,`
      1. Inside the preferences pane go to **PHP** > **Debug**.

2. In the *Xdebug* section:

      1. Depending on your requirements, enter a **Debug port**.
            - Xdebug 2 uses port 9000, Xdebug 3 uses port 9003 you can enter both `9000,9003`
      2. Select the **Can accept external connections** checkbox.
      3. Clear the **Force break at first line when no path mapping specified** and **Force break at first line when a script is outside the project** checkboxes.

![xdebug-xdebug-configuration](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/xdebug-xdebug-configuration.png){height="" width=""}

3. In the *External connections* section:

      1. For **Max. simultaneous connection**, select **5**.
      2. Clear the **Ignore external connections through unregistered server configurations** and **Break at first line in PHP scripts** checkboxes.

![image 2](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/xdebug-external-connections-configuration.png){height="" width=""}

### Configuring servers 
To configure servers:
1. Go to **Preferences** > **PHP** > **Servers**.

2. Add a server:

    1. For **Name**, enter *spryker*.
    2. For **Host**, enter *spryker*.
    3. Leave the default **Port** as 80.
    4. Select *Xdebug* in the **Debugger** dropdown.
    5. Select the **Use path mappings** checkbox.
    6. Set the absolute path to the `/data` folder on the server for the folder with your Spryker project files.
    ![Servers config](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/servers-confg.png){height="" width=""}
    
### Connecting to the server
It is possible that this section is no longer required, but it still seems necessary for the configuration to work.

1. Make sure you have the Xdebug [Extension](https://www.jetbrains.com/help/phpstorm/2021.1/browser-debugging-extensions.html) installed.
      1. There should be a server dropdown in the top right corner open it and select **Edit Configurations...**
      2. Click on the Plus Icon (**Add New Configuration**) in the top right corner or use `Ctrl/Cmd + N`
      3. Select the **PHP Remote Debug** template and name the config *spryker*
            - Filter debug connection by IDE key [X]
            - Server: spryker
            - IDE key(session id): PHPSTORM
      <Configuration Pic>
      4. Click Apply
    
### Troubleshooting

- *I think I have everything installed correctly but my breakpoint doesn't seem to be working.*

Here is a good smoke test for making sure your Xdebug configuration is all set.

1. Open the preferences pane again and go to **PHP** > **Debug**

      1. Check **Break at first line in PHP scripts** checkbox.
      2. Rerun/Refresh your app.
      3. The app should break at the `index.php` and will open a debugger pane in the IDE:
      <Debugger Pane Pic>
      4. After this you can re-try your breakpoints
       

## Switching to the debugging mode
There are several ways to switch to the debugging mode:

* To debug a web application, pass the `XDEBUG_SESSION` cookie with a string value. If you are using the Xdebug helper browser extension, in the extension menu, select **debug**.
* To run all applications in the debugging mode, run `docker/sdk {run|start|up} -x`.
* To debug a console command in cli, run `{command} -x`.




## Debugging with Xdebug

To debug an application:

1. Make a breakpoint:
![Breakpoint](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/breakpoint.png)

2. Select *Start listening* ![Start listening](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/start-listening.png).

3. Open the application in a browser.

4. Navigate to the action you have configured the breakpoint for in step 1. The debugging process should be running in the IDE:
![Debug process](https://spryker.s3.eu-central-1.amazonaws.com/docs/Developer+Guide/Installation/Spryker+in+Docker/Debugging+Setup+in+Docker/debug-process.png)




## Configuring For VSCode

This section describes the required configuration for Xdebug in VSCode.

### Prerequisites

1. VScode - insiders version preferred
 - You can download VSCode [here](https://code.visualstudio.com/insiders/)
2. Xdebug 
 - You can install and verify it [here](https://xdebug.org/docs/install)
 



## Avoiding timeouts

The default Zed Request timeout is 60 seconds. Debugging requests often take more than 60 seconds to complete. In this case, a browser stops the connection. 

To avoid Zed Request timeouts, adjust your configuration as follows:
```php
$config[ZedRequestConstants::CLIENT_OPTIONS] = [
    'timeout' => 300,
];
```

300 seconds should suit most cases, but you can increase it or even make it unlimited by defining the value as `0`.

:::(Warning) (Unlimited timeout)
If you set unlimited timeout, this affects all Zed Requests, not only debugging ones. 

